{{- if and .secrets (not .ephemeral) (or .personal .work) }}
{{-   $destDir := printf "%s" .chezmoi.destDir }}
{{-   $sourceDir := .chezmoi.sourceDir }}
{{-   $key := "" }}
{{-   $config := "" }}
{{-   $keySrc := "" }}
{{-   $configSrc := "" }}
{{-   $mainConfigSrc := joinPath $sourceDir "private_dot_ssh" "private_config.tmpl" }}
{{-   if .work }}
{{-     $key = joinPath $destDir ".ssh" "keys" "work" }}
{{-     $config = joinPath $destDir ".ssh" "config.d" "work" }}
{{-     $keySrc = joinPath $sourceDir "private_dot_ssh" "private_keys" "encrypted_private_work.age" }}
{{-     $configSrc = joinPath $sourceDir "private_dot_ssh" "config.d" "encrypted_work.age" }}
{{-   else if .personal }}
{{-     $key = joinPath $destDir ".ssh" "keys" "frey" }}
{{-     $config = joinPath $destDir ".ssh" "config.d" "personal" }}
{{-     $keySrc = joinPath $sourceDir "private_dot_ssh" "private_keys" "encrypted_private_frey.age" }}
{{-     $configSrc = joinPath $sourceDir "private_dot_ssh" "config.d" "encrypted_personal.age" }}
{{-   end }}
#requires -version 5.0
$ErrorActionPreference = "Stop"

# Ensure SSH is configured and keys are available before externals try to
# clone private repos
#
# Re-run when key existence changes:
#   Does key exist?: {{ ne (stat $key) nil }}

$SSH_KEY = "{{ .chezmoi.destDir }}/.ssh/keys/frey"

# Source common functions
. "{{ .chezmoi.workingTree }}/scripts/common.ps1"

function Apply-File {
    param(
        [Parameter(Mandatory=$true)][string]$Src,
        [Parameter(Mandatory=$true)][string]$Dest
    )

    # Skip if destination already has content
    if ((Test-Path $Dest) -and (Get-Item $Dest).Length -gt 0) {
        return $true
    }

    # Create parent directory if needed
    $parentDir = Split-Path -Parent $Dest
    if (-not (Test-Path $parentDir)) {
        New-Item -ItemType Directory -Path $parentDir -Force | Out-Null
    }

    Write-Host "Populating $Dest"

    try {
        # Handle different file types
        if ($Src -match '\.tmpl$') {
            # Template file - execute template
            Get-Content $Src | chezmoi execute-template | Set-Content $Dest -NoNewline
        }
        elseif ($Src -match '\.age$') {
            # Encrypted file - decrypt
            chezmoi decrypt $Src | Set-Content $Dest -NoNewline
        }
        else {
            # Plain file - copy
            Copy-Item -Path $Src -Destination $Dest -Force
        }

        # Set user-only permissions
        Set-UserOnlyFileAccess -Pathname $Dest

        return $true
    }
    catch {
        # Clean up on error
        if (Test-Path $Dest) {
            Remove-Item $Dest -Force
        }
        Write-Host "Error processing $Src : $_"
        return $false
    }
}

# Check if SSH key exists
if (-not (Test-Path $SSH_KEY) -or (Get-Item $SSH_KEY).Length -eq 0) {
    Write-Host "Bootstrapping SSH keys for chezmoi private repository access"

    $SSH_DIR = "$env:CHEZMOI_DEST_DIR/.ssh"

    # Create SSH directories
    $dirs = @(
        $SSH_DIR,
        "$SSH_DIR/keys",
        "$SSH_DIR/config.d"
    )

    foreach ($dir in $dirs) {
        if (-not (Test-Path $dir)) {
            New-Item -ItemType Directory -Path $dir -Force | Out-Null
        }

        # Set directory permissions - user-only access
        try {
            icacls $dir /inheritance:d | Out-Null
            icacls $dir /grant "${env:USERNAME}:(OI)(CI)F" | Out-Null
            icacls $dir /remove *S-1-5-11 *S-1-5-18 *S-1-5-32-544 *S-1-5-32-545 | Out-Null
        }
        catch {
            Write-Warning "Could not fully restrict permissions on ${dir}: $_"
        }
    }

    # Apply SSH key
    if (-not (Apply-File -Src "{{ $keySrc }}" -Dest "{{ $key }}")) {
        exit 1
    }

    # Apply SSH config
    if (-not (Apply-File -Src "{{ $configSrc }}" -Dest "{{ $config }}")) {
        exit 1
    }

    # Remove and re-apply main SSH config
    $mainConfig = "$SSH_DIR/config"
    if (Test-Path $mainConfig) {
        Remove-Item $mainConfig -Force
    }
    if (-not (Apply-File -Src "{{ $mainConfigSrc }}" -Dest $mainConfig)) {
        exit 1
    }

    Write-Host "SSH keys bootstrap complete"
}
{{- end }}
