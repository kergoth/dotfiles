#!/usr/bin/env chezmoi-exec
#!/usr/bin/env bash

set -euo pipefail

scriptdir=$(cd "$(dirname "$0")" && pwd -P)
PATH="$scriptdir/macos:$scriptdir:$PATH"
DOTFILES_DIR="$(dirname "$scriptdir")"

# shellcheck source=./common.sh
. "$scriptdir/common.sh" || exit 1

{{ if .macos_split_user -}}
export OSX_ADMIN_LOGNAME="{{ .macos_admin_user }}"
if [ "$USER" != "$OSX_ADMIN_LOGNAME" ]; then
    # Re-execute ourselves as the admin user. We need to re-execute the generated temporary file created by chezmoi-exec,
    # but need to make sure we keep overriding $0 to its original path. Since this is a chezmoi-exec generated script,
    # created by the non-admin user, we need to get its contents with sudo and re-execute it with the admin user.
    admindo \
        env PATH="$PATH" \
        CHEZMOI_EXEC_SCRIPT="$CHEZMOI_EXEC_SCRIPT" \
        DOTFILES_DIR="$DOTFILES_DIR" \
        HOMEBREW_PREFIX="$HOMEBREW_ADMIN_PREFIX" \
        ${GITHUB_TOKEN:+GITHUB_TOKEN="$GITHUB_TOKEN"} \
        ${CHEZMOI_GITHUB_ACCESS_TOKEN:+CHEZMOI_GITHUB_ACCESS_TOKEN="$CHEZMOI_GITHUB_ACCESS_TOKEN"} \
        bash -c ". \"$scriptdir/common.sh\"; need_sudo; sudorun cat \"$CHEZMOI_EXEC_SCRIPT\" | exec -a \"$0\" bash -s -- \"$USER\""
    exit $?
fi

need_sudo

# Hide admin user from the login window
sudorun dscl . create "/Users/$USER" IsHidden 1

# Hide admin user home directory
sudorun chflags hidden "/Users/$USER"

# Remove admin user from FileVault
if sudorun fdesetup list | grep "^$USER," >/dev/null; then
    sudorun fdesetup remove -user "$USER"
fi
{{ else }}
need_sudo
{{- end }}

if ! [ -e /nix ] || [ -z "$(find /nix -mindepth 1 -maxdepth 1 -type d | head -n 1)" ]; then
    install_nix
fi

if ! [ -x "$HOMEBREW_PREFIX/bin/brew" ]; then
    msg "Installing homebrew"
    install-brew -s "$HOMEBREW_PREFIX" || {
        rm -rf "$HOMEBREW_PREFIX"
        die "Failed to install homebrew"
    }
fi

msg "Installing applications with homebrew"
brewfile_install - <<EOF
{{ includeTemplate (joinPath .chezmoi.workingTree "scripts/macos/Brewfile-admin.tmpl") . }}
EOF
{{ $abs_glob := joinPath .chezmoi.sourceDir ".." "scripts/macos/Brewfile-admin.d/*" -}}
{{ $root := . -}}
{{ range $abs := (glob $abs_glob | sortAlpha) -}}
{{   $rel := trimPrefix (printf "%s/" $root.chezmoi.sourceDir) $abs -}}
{{/* Convert absolute back to a repo-relative path for include */}}
{{   $repoRel := trimPrefix (printf "%s/" (clean (joinPath $root.chezmoi.sourceDir ".."))) $abs -}}
{{   $name := base $abs -}}
{{   if and (ne $name ".keep") (ne $name ".DS_Store") -}}
{{     includeTemplate (joinPath $root.chezmoi.workingTree $repoRel) . -}}
{{   end -}}
{{ end }}

msg "Configuring system"
{{ includeTemplate (joinPath .chezmoi.workingTree "scripts/macos/configure-admin.tmpl") . }}
