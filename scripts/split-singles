#!/bin/sh

investigate_threshold=1
destdir=.

if which gln >/dev/null 2>&1; then
    alias ln=gln
fi

if [ $# -eq 0 ]; then
    set -- .
fi

for source_dir; do
    if [ "$(cd "$source_dir" && pwd -P)" = "$(pwd -P)" ]; then
        # Don't recurse into ourselves
        continue
    fi
    for dir in "$source_dir"/*/*/; do
        if [ ! -e "$dir" ]; then
            continue
        fi
        dir="${dir%/}"
        count=$(find "$dir/" -not -name ._\* \( -type f -o -type l \) | wc -l)
        # count=$(find "$dir" -iname \*.flac -o -iname \*mp3 -o -iname \*.m4a -o -iname \*.ogg | wc -l)
        if [ $count -lt 1 ]; then
            continue
        fi
        total="$(find "$dir/" -not -name ._\* \( -iname \*.flac -o -iname \*mp3 -o -iname \*.m4a -o -iname \*.ogg \) | head -n 1 | tr '\n' '\0' | xargs -0 ffprobe 2>&1 | sed -n -e 's# *track *:##p' | grep / | cut -d/ -f2)"
        if [ -z "$total" ]; then
            if [ $count -gt 1 ]; then
                d="./_Complete Albums"
            else
                d="./_Single-Track"
            fi
        elif [ $count -ge $total ]; then
            if [ $total -le 2 ]; then
                d="./_Complete Singles"
            else
                d="./_Complete Albums"
            fi
        elif [ $total -eq 1 ]; then
            d="./_Single-Track"
        else
            if [ $count -gt "$investigate_threshold" ]; then
                d="./_Incomplete Albums"
            else
                d="./_Single-Track"
            fi
        fi
        echo "$dir: $count / $total"
        mkdir -p "$d/$(dirname "$dir")"
        rm -f "$d/$dir"
        ln -rsfv "$dir" "$d/$dir"
    done
done
