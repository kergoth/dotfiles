#!/usr/bin/env bash

set -euo pipefail

scriptdir=$(cd "$(dirname "$0")" && pwd -P)
repodir=$(dirname "$scriptdir")
PATH="$scriptdir/macos:$scriptdir:$PATH"

# shellcheck source=./common.sh
. "$scriptdir/common.sh" || exit 1

if ! [ -x "$HOMEBREW_PREFIX/bin/brew" ]; then
    msg "Installing homebrew"
    install-brew -s "$HOMEBREW_PREFIX" || {
        rm -rf "$HOMEBREW_PREFIX"
        die "Failed to install homebrew"
    }
fi

msg "Installing applications with homebrew"
unset HOMEBREW_AUTO_UPDATE
export HOMEBREW_NO_AUTO_UPDATE=1

# shellcheck disable=SC2154
"$HOMEBREW_PREFIX/bin/brew" bundle --no-upgrade install --file="$scriptdir/macos/Brewfile"

if [ "$(sw_vers -productVersion | cut -d. -f1)" -lt 14 ]; then
    "$HOMEBREW_PREFIX/bin/brew" bundle --no-upgrade install --file="$scriptdir/macos/Brewfile-pre-Sonoma"
fi

# Dotfiles
"$repodir/script/setup"

# Install PowerShell modules and prompt, if needed
if has pwsh; then
    msg "Installing PowerShell modules"
    # Ignore failure, as these are not critical to my workflow, and can fail due
    # to transient network issues.
    pwsh -NoProfile "$scriptdir/install-pwsh-modules.ps1" || :

    if ! brew list --formula | grep -qFx starship; then
        msg "Installing PowerShell prompt"
        "$HOMEBREW_PREFIX/bin/brew" install starship
    fi
fi

msg "Configuring"
"$scriptdir/macos/configure"
"$scriptdir/macos/setup-apps"

msg "Configuring complete"
