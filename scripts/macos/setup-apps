#!/usr/bin/env bash

set -euo pipefail

scriptdir="$(cd "$(dirname "$0")" && pwd -P)"
PATH="$scriptdir:$scriptdir/../scripts:$PATH"

app_path() {
    for dir in /Applications ~/Applications /Applications/Utility ~/Applications/Utility; do
        if [ -d "$dir/$1.app" ]; then
            echo "$dir/$1.app"
            return 0
        fi
    done
    return 1
}

app_installed_directly() {
    app_path "$1" >/dev/null
}

add_login() {
    osascript -e "tell application \"System Events\" to make login item at end with properties {path:\"$1\", hidden:false}"
}

if app_installed_directly "Transmission Remote GUI"; then
    duti -vs com.transgui .torrent viewer
fi

if app_installed_directly "BetterZip"; then
    # Don't let BetterZip take over epub from Apple Books
    duti-all -n com.apple.iBooksX |
        grep epub |
        tr '\n' '\0' |
        xargs -0 -I"{}" sh -c "{}"
fi

# Prefer Keka as the default archive extractor
if app_installed_directly "Keka"; then
    bundle_id=com.aone.keka

    # Clone Archive Utility's associations to Keka
    archive_app=
    if [ -d "/System/Library/CoreServices/Applications/Archive Utility.app" ]; then
        archive_app="/System/Library/CoreServices/Applications/Archive Utility.app"
    elif [ -d "/System/Library/CoreServices/Archive Utility.app" ]; then
        archive_app="/System/Library/CoreServices/Archive Utility.app"
    fi

    if [ -n "$archive_app" ] && command -v duti-switch >/dev/null 2>&1; then
        duti-switch "$archive_app" "$bundle_id"
    fi

    # Explicitly map common archive extensions so we also cover formats Archive
    # Utility doesn't own.
    for ext in \
        zip \
        7z \
        rar \
        tar \
        gz \
        bz2 \
        xz \
        zst \
        zstd
    do
        duti -vs "$bundle_id" ".$ext" viewer
    done
fi

# Open these apps so they set up auto-start for themselves
while read -r app; do
    if app_installed_directly "$app"; then
        open -ga "$app"
    fi
done <<END
1Password
Raycast
Ice
Karabiner-Elements
OverSight
ReiKey
END

while read -r app; do
    if app_file_path="$(app_path "$app")"; then
        add_login "$app_file_path"
        open -ga "$app"
    fi
done <<END
BlockBlock Helper
PopClip
Shifty
Syncthing
UnPlugged
WiFi Signal
Rectangle
END

if appcleaner="$(app_path "AppCleaner")"; then
    open -g "$appcleaner/Contents/Library/LoginItems/AppCleaner SmartDelete.app"
fi

if ccc="$(app_path "Carbon Copy Cloner")"; then
    open -g "$ccc/Contents/Library/LoginItems/CCC Dashboard.app"
fi

if oversight="$(app_path "OverSight")"; then
    add_login "$oversight/Contents/Library/LoginItems/OverSight Helper.app"
    mkdir -p ~/Library/Application\ Support/Objective-See/OverSight
    touch ~/Library/Application\ Support/Objective-See/OverSight/OverSight.log
fi

# Launch the apps with extensions that need to be registered
if app="$(app_path "QuickLook Video")"; then
    xattr -r -d com.apple.quarantine "$app"
    open -g "$app"
fi

# Deal with Quarantine
xattr -d -r com.apple.quarantine ~/Library/QuickLook

# Reload and refresh Quick Look
reload-quicklook
