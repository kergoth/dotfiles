#!/usr/bin/env bash

set -euo pipefail

scriptdir="$(cd "$(dirname "$0")" && pwd -P)"
PATH="$scriptdir:$scriptdir/../scripts:$PATH"

tmpdir=$(mktemp -d)
trap 'rm -rf "$tmpdir"' EXIT

app_path() {
    for dir in /Applications ~/Applications /Applications/Utility ~/Applications/Utility; do
        if [ -d "$dir/$1.app" ]; then
            echo "$dir/$1.app"
            return 0
        fi
    done
    return 1
}

app_installed_directly() {
    app_path "$1" >/dev/null
}

app_is_running() {
    local app_name="$1"
    local count=0

    count=$(osascript <<EOF
tell application "System Events"
    count (every process whose name is "$app_name")
end tell
EOF
)
    [ "$count" -gt 0 ]
}

open_app_if_not_running() {
    local target="$1"
    local check_app="${2:-}"
    local app_name

    # If we were given a .app path, derive the process name from it
    if [[ "$target" == *.app || "$target" == */*.app ]]; then
        app_name=$(basename "$target" .app)
        if [ -z "$check_app" ]; then
            check_app="$app_name"
        fi
        if ! app_is_running "$check_app"; then
            open -g -a "$target"
        fi
    else
        # Treat as an application name resolvable by Launch Services
        app_name="$target"
        if [ -z "$check_app" ]; then
            check_app="$app_name"
        fi
        if ! app_is_running "$check_app"; then
            open -g -a "$app_name"
        fi
    fi
}

add_login() {
    local app_name login_items_file="$2"
    app_name=$(basename "$1" .app)
    if ! grep -q "$app_name" "$login_items_file" 2>/dev/null; then
        osascript -e "tell application \"System Events\" to make login item at end with properties {path:\"$1\", hidden:false, name:\"$app_name\"}" >/dev/null
    fi
}

register_quicklook_extension_app() {
    local app="$1"
    local app_path appex bundle_id

    if ! app_path="$(app_path "$app")"; then
        return 0
    fi

    appex=$(find "$app_path/Contents/PlugIns" -name "*.appex" -maxdepth 1 2>/dev/null | head -1)
    if [[ -z "$appex" ]]; then
        return 0
    fi

    if ! bundle_id=$(/usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$appex/Contents/Info.plist" 2>/dev/null); then
        return 0
    fi

    if pluginkit -m -i "$bundle_id" >/dev/null 2>&1; then
        return 0
    fi

    open_app_if_not_running "$app"
}

# Open these apps so they set up auto-start for themselves
while read -r app; do
    if app_installed_directly "$app"; then
        open_app_if_not_running "$app"
    fi
done <<END
1Password
Raycast
Ice
END

if app_installed_directly ReiKey; then
    open_app_if_not_running ReiKey "ReiKey Helper"
fi
if app_installed_directly Karabiner-Elements; then
    open_app_if_not_running Karabiner-Elements Karabiner-Menu
fi

if appcleaner="$(app_path "AppCleaner")"; then
    open_app_if_not_running "$appcleaner/Contents/Library/LoginItems/AppCleaner SmartDelete.app"
fi

if ccc="$(app_path "Carbon Copy Cloner")"; then
    open_app_if_not_running "$ccc/Contents/Library/LoginItems/CCC Dashboard.app"
fi

# Add these apps to the login items and start them immediately
osascript -e 'tell application "System Events" to get the name of every login item' >"$tmpdir/login_items" 2>/dev/null || true
while read -r app; do
    if app_file_path="$(app_path "$app")"; then
        add_login "$app_file_path" "$tmpdir/login_items"
        open_app_if_not_running "$app"
    fi
done <<END
BlockBlock Helper
Juicy
OverSight
PopClip
Shifty
Syncthing
WiFi Signal
noTunes
END

while read -r app; do
    if app_installed_directly "$app"; then
        register_quicklook_extension_app "$app"
    fi
done <<END
Apparency
BetterZip
Suspicious Package
END
