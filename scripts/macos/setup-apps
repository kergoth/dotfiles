#!/usr/bin/env bash

set -euo pipefail

scriptdir="$(cd "$(dirname "$0")" && pwd -P)"
PATH="$scriptdir:$scriptdir/../scripts:$PATH"

app_path() {
    for dir in /Applications ~/Applications /Applications/Utility ~/Applications/Utility; do
        if [ -d "$dir/$1.app" ]; then
            echo "$dir/$1.app"
            return 0
        fi
    done
    return 1
}

app_installed_directly() {
    app_path "$1" >/dev/null
}

app_is_running() {
    local app_name="$1"
    local count

    count=$(osascript <<EOF
tell application "System Events"
    count (every process whose name is "$app_name")
end tell
EOF
)
    [ "$count" -gt 0 ]
}

open_app_if_not_running() {
    local target="$1"
    local app_name

    # If we were given a .app path, derive the process name from it
    if [[ "$target" == *.app || "$target" == */*.app ]]; then
        app_name=$(basename "$target" .app)
        if ! app_is_running "$app_name"; then
            open -g -a "$target"
        fi
    else
        # Treat as an application name resolvable by Launch Services
        app_name="$target"
        if ! app_is_running "$app_name"; then
            open -g -a "$app_name"
        fi
    fi
}

add_login() {
    osascript -e "tell application \"System Events\" to make login item at end with properties {path:\"$1\", hidden:false}"
}

if app_installed_directly "Transmission Remote GUI"; then
    duti -vs com.transgui .torrent viewer
fi

if app_installed_directly "BetterZip"; then
    # Don't let BetterZip take over epub from Apple Books
    duti-all -n com.apple.iBooksX |
        grep epub |
        tr '\n' '\0' |
        xargs -0 -I"{}" sh -c "{}"
fi

# Prefer Keka as the default archive extractor
if app_installed_directly "Keka"; then
    bundle_id=com.aone.keka

    # Clone Archive Utility's associations to Keka
    archive_app=
    if [ -d "/System/Library/CoreServices/Applications/Archive Utility.app" ]; then
        archive_app="/System/Library/CoreServices/Applications/Archive Utility.app"
    elif [ -d "/System/Library/CoreServices/Archive Utility.app" ]; then
        archive_app="/System/Library/CoreServices/Archive Utility.app"
    fi

    if [ -n "$archive_app" ] && command -v duti-switch >/dev/null 2>&1; then
        duti-switch "$archive_app" "$bundle_id"
    fi

    # Explicitly map common archive extensions so we also cover formats Archive
    # Utility doesn't own.
    for ext in \
        zip \
        7z \
        rar \
        tar \
        gz \
        bz2 \
        xz \
        zst \
        zstd
    do
        duti -vs "$bundle_id" "$ext" viewer
    done
fi

# Open these apps so they set up auto-start for themselves
while read -r app; do
    if app_installed_directly "$app"; then
        open_app_if_not_running "$app"
    fi
done <<END
1Password
Raycast
Ice
Karabiner-Elements
ReiKey
END

if appcleaner="$(app_path "AppCleaner")"; then
    open_app_if_not_running "$appcleaner/Contents/Library/LoginItems/AppCleaner SmartDelete.app"
fi

if ccc="$(app_path "Carbon Copy Cloner")"; then
    open_app_if_not_running "$ccc/Contents/Library/LoginItems/CCC Dashboard.app"
fi

# Add these apps to the login items and start them immediately
while read -r app; do
    if app_file_path="$(app_path "$app")"; then
        add_login "$app_file_path"
        open_app_if_not_running "$app"
    fi
done <<END
BlockBlock Helper
Juicy
OverSight
PopClip
Shifty
Syncthing
WiFi Signal
noTunes
END

# Open QuickLook extension apps to register their extensions
while read -r app; do
    if app_installed_directly "$app"; then
        open_app_if_not_running "$app"
    fi
done <<END
Apparency
BetterZip
Suspicious Package
END
