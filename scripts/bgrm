#!/bin/sh

set -eu

usage () {
    cat <<END >&2
Usage: ${0##*/} [options] PATH [PATH..]

Options:

  -d DELAY_SECONDS  Rename/move the specified paths out of the way, then
                    remove them in the background.

  -n IONICE_CLASS   Class to specify for ionice to lower the I/O priority of
                    the removal process.
  -p IONICE_BESTEFFORT_PRIORITY     Set the priority used when IONICE_CLASS
                                    is set to 2 (Best-Effort). Default: 7 (Lowest)
END
    exit 1
}

main () {
    process_arguments "$@"
    shift $((OPTIND - 1))

    items="$(mktemp bgrm.XXXXXX)" || exit 1
    trap 'rm -f "$items"' EXIT INT TERM

    while [ $# -gt 0 ]; do
        echo "$1" >>"$items"
        shift
    done

    while read -r item; do
        if [ "${item%bgrm.}" != "$item" ]; then
            # Existing bgrm directories can presumably be skipped
            continue
        fi
        if [ ! -e "$item" ] && [ ! -L "$item" ]; then
            continue
        fi

        dir="$(dirname "$item")"
        tmpdir="$(mktemp -d "$dir/bgrm.XXXXXX")" || exit 1

        mv "$item" "$tmpdir/" && set -- "$@" "$tmpdir"
    done <"$items"

    if [ -n "$delay" ]; then
        nohup sh -c "sleep \"$delay\" && $rm_cmd \"\$@\"" - "$@" &
    else
        nohup $rm_cmd "$@" &
    fi >/dev/null 2>&1 </dev/null
}

process_arguments () {
    delay=
    idle_class=
    idle_2_priority=7

    while getopts d:n:p:h opt; do
        case "$opt" in
            d)
                delay="$OPTARG"
                ;;
            n)
                idle_class="$OPTARG"
                case "$idle_class" in
                    [0123])
                        ;;
                    *)
                        echo >&2 "Invalid idle class: $idle_class, please specify 0, 1, 2, or 3."
                        echo >&2 "See 'man ionice' for details."
                        return 1
                        ;;
                esac
                ;;
            p)
                idle_2_priority="$OPTARG"
                case "$idle_2_priority" in
                    [01234567])
                        ;;
                    *)
                        echo >&2 "Invalid idle Best-Effort priority: $idle_2_priority, please specify 0-7."
                        echo >&2 "See 'man ionice' for details."
                        return 1
                        ;;
                esac
                ;;
            h|\?)
                usage
                ;;
        esac
    done
    shift $((OPTIND - 1))

    if [ $# -eq 0 ]; then
        echo >&2 "Error: no argument specified"
        usage
    fi

    if [ -n "$idle_class" ] && which ionice >/dev/null 2>&1; then
        if [ "$idle_class" = "2" ]; then
            rm_cmd="ionice -c $idle_class -n $idle_2_priority rm -rf"
        else
            rm_cmd="ionice -c $idle_class rm -rf"
        fi
    else
        rm_cmd="rm -rf"
    fi
}

main "$@"
