#!/bin/sh
# Install packages into a fresh homebrew install, then symlink its
# binaries/scripts into $XDG_DATA_HOME/../bin

XDG_DATA_HOME="${XDG_DATA_HOME:-~/.local/share}"
HOMEBREWS_HOME="${HOMEBREWS_HOME:-$XDG_DATA_HOME/homebrews}"

if [ $# -eq 0 ]; then
    echo >&2 "Usage: ${0##*/} BREWENV_NAME [BREW_ARGS..]"
    echo >&2
    echo >&2 "Existing isolated homebrew installations:"
    for dir in "$HOMEBREWS_HOME"/*/; do
        printf >&2 '  %s\n' "$(basename "${dir%/}")"
    done
    exit 2
fi

brewenv="$1"
shift
brewenv_dir="$HOMEBREWS_HOME/$brewenv"
if [ ! -e "$brewenv_dir" ]; then
    if which brew >/dev/null 2>&1; then
        git clone-via "$(brew --prefix)" "$brewenv_dir"
    else
        git clone https://github.com/Homebrew/homebrew.git "$brewenv_dir"
    fi
fi

PATH="$brewenv_dir/bin:$PATH"

if [ $# -eq 0 ]; then
    set -- "$brewenv"
fi
brew install "$@"

mkdir -p "$XDG_DATA_HOME/../bin"
for script in "$brewenv_dir/bin/"*; do
    filename="${script##*/}"
    case "$filename" in
        brew):
            continue
            ;;
    esac
    ln -sfv "$script" "$XDG_DATA_HOME/../bin/$filename"
done
