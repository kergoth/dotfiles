
var CI=Components.interfaces,CC=Components.classes,CR=Components.results,gFP;const gGetSafeAttr=function(n,name,def){return n?(n.hasAttribute(name)?n.getAttribute(name):def):def;};const gGetSafeAttrB=function(n,name,def){return n?(n.hasAttribute(name)?n.getAttribute(name)=="true":def):def;};const gMatchingProxyFactory=function(proxy,aMatch,uri,type,errMsg){return CC["@leahscape.org/foxyproxy/matchingproxy;1"].createInstance(CI.nsISupports).wrappedJSObject.init(proxy,aMatch,foxyproxy.prototype.logg._noURLs?foxyproxy.prototype.logg.noURLsMessage:uri,type,errMsg);},gObsSvc=CC["@mozilla.org/observer-service;1"].getService(CI.nsIObserverService),gBroadcast=function(subj,topic,data){var bool=CC["@mozilla.org/supports-PRBool;1"].createInstance(CI.nsISupportsPRBool);bool.data=subj;var d;if(typeof(data)=="string"){var d=CC["@mozilla.org/supports-string;1"].createInstance(CI.nsISupportsString);d.data=data;}
else{data&&(d=data.QueryInterface(CI.nsISupports));}
gObsSvc.notifyObservers(bool,topic,d);};function foxyproxy(){this.wrappedJSObject=this;}
foxyproxy.prototype={PFF:" ",_mode:"patterns",_selectedProxy:null,_selectedTabIndex:0,_proxyDNS:false,_initialized:false,_toolsMenu:true,_contextMenu:true,_toolsMenuNode:null,_contextMenuNode:null,_advancedMenus:false,autoadd:null,quickadd:null,QueryInterface:function(aIID){if(!aIID.equals(CI.nsISupports)&&!aIID.equals(CI.nsIObserver)&&!aIID.equals(CI.nsISupportsWeakReference))
throw CR.NS_ERROR_NO_INTERFACE;return this;},__registration:function(){return({topics:["app-startup","xpcom-shutdown"],observerName:"foxyproxy_catobserver",contractId:"@leahscape.org/foxyproxy/service;1",classId:Components.ID("{46466e13-16ab-4565-9924-20aac4d98c82}"),constructor:foxyproxy,className:"FoxyProxy Core"});},observe:function(subj,topic,data){switch(topic){case"app-startup":gObsSvc.addObserver(this,"quit-application",false);gObsSvc.addObserver(this,"domwindowclosed",false);this._loadStrings();break;case"domwindowclosed":var wm=CC["@mozilla.org/appshell/window-mediator;1"].getService(CI.nsIWindowMediator);var win=wm.getMostRecentWindow("navigator:browser");if(!win){this.closeAppWindows("foxyproxy",wm);this.closeAppWindows("foxyproxy-quickadd",wm);this.closeAppWindows("foxyproxy-options",wm);}
break;case"quit-application":gObsSvc.removeObserver(this,"quit-application");gObsSvc.removeObserver(this,"domwindowclosed");break;}},_loadStrings:function(){var req=CC["@mozilla.org/xmlextras/xmlhttprequest;1"].createInstance(CI.nsIXMLHttpRequest);req.open("GET","chrome://foxyproxy/content/strings.xml",false);req.send(null);this.strings._entities=new Array();for(var i=0,e=req.responseXML.getElementsByTagName("i18n");i<e.length;i++){var attrs=e.item(i).attributes;this.strings._entities[attrs.getNamedItem("id").nodeValue]=attrs.getNamedItem("value").nodeValue;}},closeAppWindows:function(type,wm){var wm=CC["@mozilla.org/appshell/window-mediator;1"].getService(CI.nsIWindowMediator);var e=wm.getEnumerator(type);while(e.hasMoreElements()){e.getNext().close();}},init:function(){if(!this._initialized){this._initialized=true;gFP=this;this.autoadd=new SuperAdd("autoadd");this.quickadd=new QuickAdd("quickadd");this.autoadd.init(this.getMessage("autoadd.pattern.label"),this);this.quickadd.init(this.getMessage("quickadd.pattern.label"),this);var req=CC["@mozilla.org/xmlextras/xmlhttprequest;1"].createInstance(CI.nsIXMLHttpRequest);var settingsURI=this.getSettingsURI("uri-string");req.open("GET",settingsURI,false);req.send(null);var doc=req.responseXML,docElem=doc.documentElement;if(docElem.nodeName=="parsererror"){this.alert(null,this.getMessage("settings.error"));this.writeSettings(settingsURI);}
else
this.fromDOM(doc,docElem);var doc=CC["@mozilla.org/xml/xml-document;1"].createInstance(CI.nsIDOMDocument);this._contextMenuNode=doc.createElement("menu");this._contextMenuNode.setAttribute("id","foxyproxy-context-menu-1");this._contextMenuNode.setAttribute("label","&foxyproxy.label;");this._contextMenuNode.setAttribute("tooltiptext","&foxyproxy.tooltip;");this._contextMenuNode.setAttribute("accesskey","&foxyproxy.accesskey;");this._contextMenuNode.setAttribute("class","menu-iconic foxyproxybutton-small");var menupopup2=doc.createElement("menupopup");menupopup2.setAttribute("id","foxyproxy-contextmenu-popup");menupopup2.setAttribute("onpopupshowing","foxyproxy.onPopupShowing(this, event);");menupopup2.setAttribute("onpopuphiding","foxyproxy.onPopupHiding();");this._contextMenuNode.appendChild(menupopup2);}},get contextMenuNode(){return this._contextMenuNode.cloneNode(true);},get mode(){return this._mode;},setMode:function(mode,writeSettings,init){this._selectedProxy=null;for(var i=0,len=this.proxies.length;i<len;i++){if(mode==this.proxies.item(i).id){this._selectedProxy=this.proxies.item(i);this.proxies.item(i).enabled=true;}
this.proxies.item(i).handleTimer();}
this._mode=mode;this.toggleFilter(mode!="disabled");if(init)return;writeSettings&&this.writeSettings();gBroadcast(this.autoadd._enabled,"foxyproxy-mode-change",this._mode);},cycleMode:function(){var self=this;if(this._selectedProxy&&this._selectedProxy.lastresort){this.setMode("disabled",true);}
else if(this._mode=="disabled"){this.setMode("patterns",true);}
else if(this._mode=="patterns"){var p=this.proxies.item(0);(!p||!p.enabled||!p.includeInCycle)&&(p=_getNextInCycle(this.proxies.item(0).id));this.setMode(p?p.id:"disabled",true);}
else{var p=_getNextInCycle(this._mode);this.setMode(p?p.id:"disabled",true);}
function _getNextInCycle(start){for(var p=self.proxies.getNextById(start);p&&!p.includeInCycle;p=self.proxies.getNextById(p.id));return p;}},toggleFilter:function(enabled){var ps=CC["@mozilla.org/network/protocol-proxy-service;1"].getService(CI.nsIProtocolProxyService);ps.unregisterFilter(this);enabled&&ps.registerFilter(this,0);},applyFilter:function(ps,uri,proxy){function _err(fp,info,extInfo){var def=fp.proxies.item(fp.proxies.length-1);mp=gMatchingProxyFactory(def,null,spec,"err",extInfo?extInfo:info);fp.notifier.alert(info,fp.getMessage("see.log"));return def;}
try{var spec=uri.spec;var mp=this.applyMode(spec);var ret=mp.proxy.getProxy(spec,uri.host,mp);return ret?ret:_err(this,this.getMessage("route.error"));}
catch(e){dump("applyFilter: "+e+"\n");return _err(this,this.getMessage("route.exception",[""]),this.getMessage("route.exception",[": "+e]));}
finally{gObsSvc.notifyObservers(mp.proxy,"foxyproxy-throb",null);this.logg.add(mp);}},getPrefsService:function(str){return CC["@mozilla.org/preferences-service;1"].getService(CI.nsIPrefService).getBranch(str);},getSettingsURI:function(type){var o=null;try{o=this.getPrefsService("extensions.foxyproxy.").getCharPref("settings");}
catch(e){}
if(o){o==this.PFF&&(o=this.getDefaultPath());var file=this.transformer(o,CI.nsIFile);if(!file.exists()){this.writeSettings(file);}}
else{o=this.setSettingsURI(this.getDefaultPath());}
return this.transformer(o,type);},setSettingsURI:function(o){var o2=this.transformer(o,"uri-string");try{this.writeSettings(o2);this.getPrefsService("extensions.foxyproxy.").setCharPref("settings",o==this.PFF?this.PFF:o2);}
catch(e){this.alert(this,this.getMessage("error")+":\n\n"+e);}
return o==this.PFF?this.PFF:o2;},isUsingPFF:function(){return this.getPrefsService("extensions.foxyproxy.").getCharPref("settings")==this.PFF;},alert:function(wnd,str){CC["@mozilla.org/embedcomp/prompt-service;1"].getService(CI.nsIPromptService).alert(null,this.getMessage("foxyproxy"),str);},getDefaultPath:function(){var file=CC["@mozilla.org/file/local;1"].createInstance(CI.nsILocalFile);var dir=CC["@mozilla.org/file/directory_service;1"].getService(CI.nsIProperties).get("ProfD",CI.nsILocalFile);file.initWithPath(dir.path);file.appendRelativePath("foxyproxy.xml");return file;},transformer:function(o,desiredType){o==this.PFF&&(o=this.getDefaultPath());const handler=CC["@mozilla.org/network/io-service;1"].getService(CI.nsIIOService).getProtocolHandler("file").QueryInterface(CI.nsIFileProtocolHandler);switch(desiredType){case"uri-string":switch(typeof(o)){case"string":if(o.indexOf("://">-1))return o;return handler.getURLSpecFromFile(this.createFile(o));case"object":if(o instanceof CI.nsIFile)return handler.getURLSpecFromFile(o);if(o instanceof CI.nsIURI)return o.spec;return null;}
case"file-string":switch(typeof(o)){case"string":if(o.indexOf("://">-1))return handler.getFileFromURLSpec(o).path;return o;case"object":if(o instanceof CI.nsIFile)return o.path;if(o instanceof CI.nsIURI)return handler.getFileFromURLSpec(o.spec).path;return null;}
case CI.nsIFile:switch(typeof(o)){case"string":if(o.indexOf("://">-1))return handler.getFileFromURLSpec(o);return this.createFile(o).path;case"object":if(o instanceof CI.nsIFile)return o;if(o instanceof CI.nsIURI)return handler.getFileFromURLSpec(o.spec);return null;}
case CI.nsIURI:var ios=CC["@mozilla.org/network/io-service;1"].getService(CI.nsIIOService);switch(typeof(o)){case"string":if(o.indexOf("://">-1))return ios.newURI(o,null,null);return handler.newFileURI(this.createFile(o));case"object":if(o instanceof CI.nsIFile)return handler.newFileURI(o);if(o instanceof CI.nsIURI)return o;return null;}}},createFile:function(str){var f=CC["@mozilla.org/file/local;1"].createInstance(CI.nsILocalFile);f.initWithPath(str);return f;},writeSettings:function(o){!o&&(o=gFP.getPrefsService("extensions.foxyproxy.").getCharPref("settings"));o=gFP.transformer(o,CI.nsIFile);var foStream=CC["@mozilla.org/network/file-output-stream;1"].createInstance(CI.nsIFileOutputStream);foStream.init(o,0x02|0x08|0x20,0664,0);foStream.write("<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n",39);CC["@mozilla.org/xmlextras/xmlserializer;1"].createInstance(CI.nsIDOMSerializer).serializeToStream(gFP.toDOM(),foStream,"UTF-8");foStream.close();},get proxyDNS(){return this._proxyDNS;},set proxyDNS(p){this._proxyDNS=p;this.writeSettings();},get selectedTabIndex(){return this._selectedTabIndex;},set selectedTabIndex(i){this._selectedTabIndex=i;this.writeSettings();},get logging(){return this.logg.enabled;},set logging(e){this.logg.enabled=e;this.writeSettings();},get toolsMenu(){return this._toolsMenu;},set toolsMenu(e){this._toolsMenu=e;gBroadcast(e,"foxyproxy-toolsmenu");this.writeSettings();},get contextMenu(){return this._contextMenu;},set contextMenu(e){this._contextMenu=e;gBroadcast(e,"foxyproxy-contextmenu");this.writeSettings();},get advancedMenus(){return this._advancedMenus;},set advancedMenus(i){this._advancedMenus=i;this.writeSettings();},applyMode:function(spec){var matchingProxy;switch(this.mode){case"random":case"patterns":matchingProxy=this.proxies.getMatches(spec);break;case"roundrobin":break;default:matchingProxy=gMatchingProxyFactory(this._selectedProxy,null,spec,"ded");break;}
return matchingProxy;},restart:function(){CC["@mozilla.org/toolkit/app-startup;1"].getService(CI.nsIAppStartup).quit(CI.nsIAppStartup.eForceQuit|CI.nsIAppStartup.eRestart);},fromDOM:function(doc,node){this.statusbar.fromDOM(doc);this.toolbar.fromDOM(doc);this.logg.fromDOM(doc);this._proxyDNS=node.getAttribute("proxyDNS")=="true";this._toolsMenu=node.hasAttribute("toolsMenu")?node.getAttribute("toolsMenu")=="true":true;this._contextMenu=node.hasAttribute("contextMenu")?node.getAttribute("contextMenu")=="true":true;this._advancedMenus=node.hasAttribute("advancedMenus")?node.getAttribute("advancedMenus")=="true":false;this._selectedTabIndex=node.getAttribute("selectedTabIndex")||"0";this.proxies.fromDOM(doc,this);this.setMode(node.hasAttribute("enabledState")?(node.getAttribute("enabledState")==""?"patterns":node.getAttribute("enabledState")):node.getAttribute("mode"),false,true);this.random.fromDOM(doc,this);this.autoadd.fromDOM(doc);this.quickadd.fromDOM(doc);this.warnings.fromDOM(doc);},toDOM:function(){var doc=CC["@mozilla.org/xml/xml-document;1"].createInstance(CI.nsIDOMDocument);var e=doc.createElement("foxyproxy");e.setAttribute("mode",this._mode);e.setAttribute("selectedTabIndex",this._selectedTabIndex);e.setAttribute("proxyDNS",this._proxyDNS);e.setAttribute("toolsMenu",this._toolsMenu);e.setAttribute("contextMenu",this._contextMenu);e.setAttribute("advancedMenus",this._advancedMenus);e.appendChild(this.random.toDOM(doc));e.appendChild(this.statusbar.toDOM(doc));e.appendChild(this.toolbar.toDOM(doc));e.appendChild(this.logg.toDOM(doc));e.appendChild(this.warnings.toDOM(doc));e.appendChild(this.autoadd.toDOM(doc));e.appendChild(this.quickadd.toDOM(doc));e.appendChild(this.proxies.toDOM(doc));return e;},random:{_includeDirect:false,_includeDisabled:false,get includeeDirect(){return this._includeDirect;},set includeeDirect(e){this._includeDirect=e;gFP.writeSettings();},get includeDisabled(){return this._includeDisabled;},set includeDisabled(e){this._includeDisabled=e;gFP.writeSettings();},toDOM:function(doc){var e=doc.createElement("random");e.setAttribute("includeDirect",this._includeDirect);e.setAttribute("includeDisabled",this._includeDisabled);return e;},fromDOM:function(doc){var node=doc.getElementsByTagName("random")[0];if(node){this._includeDirect=node.getAttribute("includeDirect")=="true";this._includeDisabled=node.getAttribute("includeDisabled")=="true";}}},proxies:{list:[],lastresort:null,push:function(p){if(this.list.length==0)
this.list[0]=p;else{var len=this.list.length-1;this.list[len+1]=this.list[len];this.list[len]=p;}
return true;},get length(){return this.list.length;},getProxyById:function(id){var a=this.list.filter(function(e){return e.id==this;},id);return a?a[0]:null;},getIndexById:function(id){var len=this.length;for(var i=0;i<len;i++){if(this.list[i].id==id)return i;}
return-1;},fromDOM:function(doc,fp){var last=null;for(var i=0,proxyElems=doc.getElementsByTagName("proxy");i<proxyElems.length;i++){var p=CC["@leahscape.org/foxyproxy/proxy;1"].createInstance(CI.nsISupports).wrappedJSObject;p.fromDOM(proxyElems[i]);if(!last&&proxyElems[i].getAttribute("lastresort")=="true")
last=p;else
this.list.push(p);}
if(last){this.list.push(last);!last.enabled&&(last.enabled=true);}
else{last=CC["@leahscape.org/foxyproxy/proxy;1"].createInstance(CI.nsISupports).wrappedJSObject;last.name=fp.getMessage("proxy.default");last.notes=fp.getMessage("proxy.default.notes");last.mode="direct";last.lastresort=true;var match=CC["@leahscape.org/foxyproxy/match;1"].createInstance(CI.nsISupports).wrappedJSObject;match.name=fp.getMessage("proxy.default.match.name");match.pattern="*";last.matches.push(match);last.selectedTabIndex=0;last.animatedIcons=false;this.list.push(last);fp.writeSettings();}
this.lastresort=last;},toDOM:function(doc){var proxiesElem=doc.createElement("proxies");for(var i=0;i<this.list.length;i++){proxiesElem.appendChild(this.list[i].toDOM(doc));}
return proxiesElem;},item:function(i){return this.list[i];},remove:function(idx){this.maintainIntegrity(this.list[idx],true,false,false);for(var i=0,temp=[];i<this.list.length;i++){if(i!=idx)temp[temp.length]=this.list[i];}
this.list=[];for(var i=0;i<temp.length;i++){this.list.push(temp[i]);}},move:function(idx,direction){var newIdx=idx+(direction=="up"?-1:1);if(newIdx<0||newIdx>this.list.length-1)return false;var temp=this.list[idx];this.list[idx]=this.list[newIdx];this.list[newIdx]=temp;return true;},getMatches:function(uriStr){for(var i=0,aMatch;i<this.list.length;i++){if(this.list[i]._enabled&&(aMatch=this.list[i].isMatch(uriStr))){return gMatchingProxyFactory(this.list[i],aMatch,uriStr,"pat");}}
return gMatchingProxyFactory(this.lastresort,this.lastresort.matches[0],uriStr,"pat");},getRandom:function(uriStr,includeDirect,includeDisabled){var isDirect=true,isDisabled=true,r,cont,maxTries=this.list.length*10;do{r=Math.floor(Math.random()*this.list.length);dump(r+"\n");cont=(!includeDirect&&this.list[r].mode=="direct")||(!includeDisabled&&!this.list[r]._enabled);dump("cont="+cont+"\n");}while(cont&&(--maxTries>0));if(maxTries==0){return this.lastresort;}
return gMatchingProxyFactory(this.list[r],null,uriStr,"rand");},getNextById:function(curId){var idx=this.getIndexById(curId);if(idx==-1)return null;for(var i=idx+1,len=this.length;i<len;i++){if(this.list[i]._enabled){return this.list[i];}}
return null;},uniqueRandom:function(){var unique=true,r;do{r=Math.floor(Math.random()*4294967296);for(var i=0;i<this.list.length&&unique;i++)
this.list[i].id==r&&(unique=false);}while(!unique);return r;},maintainIntegrity:function(proxy,isBeingDeleted,isBeingDisabled,isBecomingDIRECT){var updateViews;if(isBeingDeleted||isBeingDisabled){if(gFP._mode==proxy.id){gFP.setMode("disabled",true);updateViews=true;}}
if(gFP.autoadd.maintainIntegrity(proxy.id,isBeingDeleted)&&!updateViews){updateViews=true;}
if(gFP.quickadd.maintainIntegrity(proxy.id,isBeingDeleted)&&!updateViews){updateViews=true;}
updateViews&&gBroadcast(null,"foxyproxy-updateviews");}},logg:{owner:null,_maxSize:500,_elements:new Array(this._maxSize),_end:0,_start:0,_full:false,enabled:false,_templateHeader:"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Strict//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\"><head><title></title><link rel=\"icon\" href=\"http://foxyproxy.mozdev.org/favicon.ico\"/><link rel=\"shortcut icon\" href=\"http://foxyproxy.mozdev.org/favicon.ico\"/><link rel=\"stylesheet\" href=\"http://foxyproxy.mozdev.org/styles/log.css\" type=\"text/css\"/></head><body><table class=\"log-table\"><thead><tr><td class=\"heading\">${timestamp-heading}</td><td class=\"heading\">${url-heading}</td><td class=\"heading\">${proxy-name-heading}</td><td class=\"heading\">${proxy-notes-heading}</td><td class=\"heading\">${pattern-name-heading}</td><td class=\"heading\">${pattern-heading}</td><td class=\"heading\">${pattern-type-heading}</td><td class=\"heading\">${pattern-color-heading}</td><td class=\"heading\">${pac-result-heading}</td><td class=\"heading\">${error-msg-heading}</td></tr></thead><tfoot><tr><td/></tr></tfoot><tbody>",_templateFooter:"</tbody></table></body></html>",_templateRow:"<tr><td class=\"timestamp\">${timestamp}</td><td class=\"url\"><a href=\"${url}\">${url}</a></td><td class=\"proxy-name\">${proxy-name}</td><td class=\"proxy-notes\">${proxy-notes}</td><td class=\"pattern-name\">${pattern-name}</td><td class=\"pattern\">${pattern}</td><td class=\"pattern-type\">${pattern-type}</td><td class=\"pattern-color\">${pattern-color}</td><td class=\"pac-result\">${pac-result}</td><td class=\"error-msg\">${error-msg}</td></tr>",_timeformat:null,_months:null,_days:null,_noURLs:false,noURLsMessage:null,fromDOM:function(doc){this._timeformat=gFP.getMessage("timeformat");this.noURLsMessage=gFP.getMessage("log.nourls.url");this._months=[gFP.getMessage("months.long.1"),gFP.getMessage("months.long.2"),gFP.getMessage("months.long.3"),gFP.getMessage("months.long.4"),gFP.getMessage("months.long.5"),gFP.getMessage("months.long.6"),gFP.getMessage("months.long.7"),gFP.getMessage("months.long.8"),gFP.getMessage("months.long.9"),gFP.getMessage("months.long.10"),gFP.getMessage("months.long.11"),gFP.getMessage("months.long.12")];this._days=[gFP.getMessage("days.long.1"),gFP.getMessage("days.long.2"),gFP.getMessage("days.long.3"),gFP.getMessage("days.long.4"),gFP.getMessage("days.long.5"),gFP.getMessage("days.long.6"),gFP.getMessage("days.long.7")];var node=doc.getElementsByTagName("logg")[0];this.enabled=node.getAttribute("enabled")=="true";this._maxSize=node.hasAttribute("maxSize")?node.getAttribute("maxSize"):500;if(node.hasAttribute("header-v2")){this._templateHeader=node.getAttribute("header-v2");}
if(node.hasAttribute("footer-v2")){this._templateFooter=node.getAttribute("footer-v2");}
if(node.hasAttribute("row-v2")){this._templateRow=node.getAttribute("row-v2");}
this._noURLs=node.hasAttribute("noURLs")?node.getAttribute("noURLs")=="true":false;this.clear();},toDOM:function(doc){var e=doc.createElement("logg");e.setAttribute("enabled",this.enabled);e.setAttribute("maxSize",this._maxSize);e.setAttribute("noURLs",this._noURLs);e.setAttribute("header",this._templateHeader);e.setAttribute("row",this._templateRow);e.setAttribute("footer",this._templateFooter);return e;},toHTML:function(){var self=this,sz=this.length,ret=this._templateHeader.replace(/\${timestamp-heading}|\${url-heading}|\${proxy-name-heading}|\${proxy-notes-heading}|\${pattern-name-heading}|\${pattern-heading}|\${pattern-type-heading}|\${pattern-color-heading}|\${pac-result-heading}|\${error-msg-heading}/gi,function($0){switch($0){case"${timestamp-heading}":return gFP.getMessage("foxyproxy.tab.logging.timestamp.label");case"${url-heading}":return gFP.getMessage("foxyproxy.tab.logging.url.label");case"${proxy-name-heading}":return gFP.getMessage("foxyproxy.proxy.name.label");case"${proxy-notes-heading}":return gFP.getMessage("foxyproxy.proxy.notes.label");case"${pattern-name-heading}":return gFP.getMessage("foxyproxy.pattern.name.label");case"${pattern-heading}":return gFP.getMessage("foxyproxy.pattern.label");case"${pattern-type-heading}":return gFP.getMessage("foxyproxy.pattern.type.label");case"${pattern-color-heading}":return gFP.getMessage("foxyproxy.whitelist.blacklist.label");case"${pac-result-heading}":return gFP.getMessage("foxyproxy.pac.result.label");case"${error-msg-heading}":return gFP.getMessage("foxyproxy.error.msg.label");}});function _xmlEncode(str){return str.replace(/\<|\>|\&|\'|\"/g,function($0){switch($0){case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;";case"'":return"&apos;";case"\"":return"&quot;";}});};for(var i=0;i<sz;i++){ret+=self._templateRow.replace(/\${timestamp}|\${url}|\${proxy-name}|\${proxy-notes}|\${pattern-name}|\${pattern}|\${pattern-type}|\${pattern-color}|\${pac-result}|\${error-msg}/gi,function($0){switch($0){case"${timestamp}":return _xmlEncode(self.format(self.item(i).timestamp));case"${url}":return _xmlEncode(self.item(i).uri);case"${proxy-name}":return _xmlEncode(self.item(i).proxyName);case"${proxy-notes}":return _xmlEncode(self.item(i).proxyNotes);case"${pattern-name}":return _xmlEncode(self.item(i).matchName);case"${pattern}":return _xmlEncode(self.item(i).matchPattern);case"${pattern-type}":return _xmlEncode(self.item(i).matchType);case"${pattern-color}":return _xmlEncode(self.item(i).whiteBlack);case"${pac-result}":return _xmlEncode(self.item(i).pacResult);case"${error-msg}":return _xmlEncode(self.item(i).errMsg);}});}
return ret+this._templateFooter;},format:function(d){d=new Date(d);if(!d.valueOf())
return' ';var self=this;return this._timeformat.replace(/yyyy|mmmm|mmm|mm|dddd|ddd|dd|hh|HH|nn|ss|zzz|a\/p/gi,function($1){switch($1){case'yyyy':return d.getFullYear();case'mmmm':return self._months[d.getMonth()];case'mmm':return self._months[d.getMonth()].substr(0,3);case'mm':return zf((d.getMonth()+1),2);case'dddd':return self._days[d.getDay()];case'ddd':return self._days[d.getDay()].substr(0,3);case'dd':return zf(d.getDate(),2);case'hh':return zf(((h=d.getHours()%12)?h:12),2);case'HH':return zf(d.getHours(),2);case'nn':return zf(d.getMinutes(),2);case'ss':return zf(d.getSeconds(),2);case'zzz':return zf(d.getSeconds(),3);case'a/p':return d.getHours()<12?'AM':'PM';}});function zf(c,n){c=""+c;return c.length==1?(n==2?'0'+c:'00'+c):(c.length==2?(n==2?c:'0'+c):c);}},get length(){var size=0;if(this._end<this._start){size=this._maxSize-this._start+this._end;}else if(this._end==this._start){size=(this._full?this._maxSize:0);}else{size=this._end-this._start;}
return size;},get maxSize(){return this._maxSize;},set maxSize(m){this._maxSize=m;this.clear();gFP.writeSettings();},get noURLs(){return this._noURLs;},set noURLs(m){this._noURLs=m;gFP.writeSettings();},get templateHeader(){return this._templateHeader;},set templateHeader(t){this._templateHeader=t;gFP.writeSettings();},get templateFooter(){return this._templateFooter;},set templateFooter(t){this._templateFooter=t;gFP.writeSettings();},get templateRow(){return this._templateRow;},set templateRow(t){this._templateRow=t;gFP.writeSettings();},clear:function(){this._full=false;this._end=this._start=0;this._elements=new Array(this._maxSize);},scrub:function(){var self=this;this._elements.forEach(function(element,index,array){array[index].uri=self.noURLsMessage;});},add:function(o){if(!this.enabled)return;this.length==this._maxSize&&this._remove();this._elements[this._end++]=o;this._end>=this._maxSize&&(this._end=0);this._end==this._start&&(this._full=true);},item:function(idx){return this.length==0?null:this._elements[idx];},_remove:function(){if(this.length==0)
return;var element=this._elements[this._start];if(element){this._elements[this._start++]=null;this._start>=this._maxSize&&(this._start=0);this._full=false;}}},notifier:{alerts:function(){try{return CC["@mozilla.org/alerts-service;1"].getService(CI.nsIAlertsService);}
catch(e){return null;}}(),alert:function(title,text){if(this.alerts)
this.alerts.showAlertNotification("chrome://foxyproxy/content/images/foxyproxy-nocopy.gif",title,text,false,"",null);else{(!this.timer&&(this.timer=CC["@mozilla.org/timer;1"].createInstance(CI.nsITimer)));this.timer.cancel();var wm=CC["@mozilla.org/appshell/window-mediator;1"].getService(CI.nsIWindowMediator);var win=wm.getMostRecentWindow("navigator:browser");try{var doc=win.parent.document;this.tooltip=doc.getElementById("foxyproxy-popup");this._removeChildren(this.tooltip);var grid=doc.createElement("grid");grid.setAttribute("flex","1");this.tooltip.appendChild(grid);var columns=doc.createElement("columns");columns.appendChild(doc.createElement("column"));grid.appendChild(columns);var rows=doc.createElement("rows");grid.appendChild(rows);this._makeHeaderRow(doc,title,rows);this._makeRow(doc,"",rows);this._makeRow(doc,text,rows);this.tooltip.showPopup(doc.getElementById("status-bar"),-1,-1,"tooltip","topright","bottomright");this.timer.initWithCallback(this,5000,CI.nsITimer.TYPE_ONE_SHOT);}
catch(e){dump(e);gFP.alert(null,text);}}},notify:function(){this.tooltip.hidePopup();},_makeHeaderRow:function(doc,col,gridRows){var label=doc.createElement("label");label.setAttribute("value",col);label.setAttribute("style","font-weight: bold; text-decoration: underline; color: blue;");gridRows.appendChild(label);},_makeRow:function(doc,col1,gridRows){var gridRow=doc.createElement("row");var label=doc.createElement("label");label.setAttribute("value",col1);gridRow.appendChild(label);gridRows.appendChild(gridRow);},_removeChildren:function(node){if(node&&node.firstChild){node.removeChild(node.firstChild);this._removeChildren(node);}}},statusbar:{_iconEnabled:true,_textEnabled:true,_leftClick:"options",_middleClick:"cycle",_rightClick:"contextmenu",toDOM:function(doc){var e=doc.createElement("statusbar");e.setAttribute("icon",this._iconEnabled);e.setAttribute("text",this._textEnabled);e.setAttribute("left",this._leftClick);e.setAttribute("middle",this._middleClick);e.setAttribute("right",this._rightClick);return e;},fromDOM:function(doc){var n=doc.getElementsByTagName("statusbar")[0];this._iconEnabled=gGetSafeAttrB(n,"icon",true);this._textEnabled=gGetSafeAttrB(n,"text",true);this._leftClick=gGetSafeAttr(n,"left","options");this._middleClick=gGetSafeAttr(n,"middle","cycle");this._rightClick=gGetSafeAttr(n,"right","contextmenu");},get iconEnabled(){return this._iconEnabled;},set iconEnabled(e){this._iconEnabled=e;gFP.writeSettings();gBroadcast(e,"foxyproxy-statusbar-icon");e&&gFP.setMode(gFP.mode,false,false);},get textEnabled(){return this._textEnabled;},set textEnabled(e){this._textEnabled=e;gFP.writeSettings();gBroadcast(e,"foxyproxy-statusbar-text");e&&gFP.setMode(gFP.mode,false,false);},get leftClick(){return this._leftClick;},set leftClick(e){this._leftClick=e;gFP.writeSettings();},get middleClick(){return this._middleClick;},set middleClick(e){this._middleClick=e;gFP.writeSettings();},get rightClick(){return this._rightClick;},set rightClick(e){this._rightClick=e;gFP.writeSettings();}},toolbar:{_leftClick:"options",_middleClick:"cycle",_rightClick:"contextmenu",toDOM:function(doc){var e=doc.createElement("toolbar");e.setAttribute("left",this._leftClick);e.setAttribute("middle",this._middleClick);e.setAttribute("right",this._rightClick);return e;},fromDOM:function(doc){var n=doc.getElementsByTagName("toolbar")[0];this._leftClick=gGetSafeAttr(n,"left","options");this._middleClick=gGetSafeAttr(n,"middle","cycle");this._rightClick=gGetSafeAttr(n,"right","contextmenu");},get leftClick(){return this._leftClick;},set leftClick(e){this._leftClick=e;gFP.writeSettings();},get middleClick(){return this._middleClick;},set middleClick(e){this._middleClick=e;gFP.writeSettings();},get rightClick(){return this._rightClick;},set rightClick(e){this._rightClick=e;gFP.writeSettings();}},getMessage:function(msg,ar){try{return this.strings.getMessage(msg,ar);}
catch(e){dump(e);this.alert(null,"Error reading string resource: "+msg);}},strings:{_sbs:CC["@mozilla.org/intl/stringbundle;1"].getService(CI.nsIStringBundleService).createBundle("chrome://foxyproxy/locale/foxyproxy.properties"),_entities:null,getMessage:function(msg,ar){return ar?this._sbs.formatStringFromName(msg,ar,ar.length):(this._entities[msg]?this._entities[msg]:this._sbs.GetStringFromName(msg));}},warnings:{_noWildcards:false,get noWildcards(){return this._noWildcards;},set noWildcards(e){this._noWildcards=e;gFP.writeSettings();},toDOM:function(doc){var e=doc.createElement("warnings");e.setAttribute("no-wildcards",this._noWildcards);return e;},fromDOM:function(doc){var node=doc.getElementsByTagName("warnings")[0];node&&(this._noWildcards=node.getAttribute("no-wildcards")=="true");},}};