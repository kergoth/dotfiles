#!/bin/sh

getrev(){
    svn propget piston:remote-revision "$1"
}

update(){
    oldrev="`getrev $1`"

    logtmp=`mktemp -t`
    piston update "$1" | tee $logtmp
    updated="`cat $logtmp | sed -ne '/^  Updated to/{s/[^0-9 ]*//g; s/^ *//; p}'`"
    rm -f $logtmp

    rev="`echo $updated|cut -d' ' -f1`"
    nchanges="`echo $updated|cut -d' ' -f2`"
    if [ -n "$rev" -a "$nchanges" != "0" ]; then
        logtmp=`mktemp -t`
        echo "Updated $1 to revision $rev:" >> $logtmp
        echo >> $logtmp

        msgtmp=`mktemp -t`
        svn log -r$rev:$(($oldrev + 1)) -v --xml `svn propget piston:root "$1"` | svn2log.py -sLHO -o $msgtmp
        cat $msgtmp >> $logtmp
        rm -f $msgtmp

        svn ci -F $logtmp $1
        rm -f $logtmp

        echo "Updated $1 to revision $rev."
    fi
}

for i in "$@"; do
    update "$i"
done
