#!/bin/sh
#
# Setup the home dotfiles using detached git repositories rather than symlinks

set -e

detached_clone() {
    url="$1"
    repo="$2"
    worktree="$3/"

    git clone --no-checkout "$url" "$repo"
    cd "$repo"
    mkdir -p "$worktree"
    mv .git/* .
    rmdir .git
    GIT_DIR="$PWD" git read-tree HEAD
    GIT_DIR="$PWD" git checkout-index -a -f --prefix="$worktree" || true
    GIT_DIR="$PWD" git config core.worktree "$worktree"
    GIT_DIR="$PWD" git config status.showUntrackedFiles no
}

detached_clone git://github.com/kergoth/homefiles ~/.fgits/homefiles.git ../..
detached_clone git://github.com/kergoth/git-scripts ~/.fgits/git-scripts.git ../../bin
curl -s https://raw.github.com/kergoth/vim-kergoth/master/scripts/setup.sh | sh

{
    echo
    echo "Homefiles configuration completed"
    echo
    echo "To enter the git context of one of the homefile repositories,"
    echo "if under zsh: run 'fgit REPO' to enter the context, 'unfgit' to leave it"
    echo "if under bash: run 'vcsh REPO' to enter the context, 'exit' to leave it"
    echo
    echo "Available repositories:"
    /bin/ls ~/.fgits 2>/dev/null | sed -e's,\.git$,,'
    echo
}>&2