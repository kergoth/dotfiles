#!/bin/sh
#
# Setup the home dotfiles using detached git repositories rather than symlinks

set -e

detached_clone() {
    url="$1"
    repo="$2"
    worktree="$3/"

    git clone --no-checkout "$url" "$repo"
    cd "$repo"
    mkdir -p "$worktree"
    mv .git/* .
    rmdir .git
    GIT_DIR="$PWD" git read-tree HEAD
    GIT_DIR="$PWD" git checkout-index -a -f --prefix="$worktree" || true
    GIT_DIR="$PWD" git config core.worktree "$worktree"
    GIT_DIR="$PWD" git config status.showUntrackedFiles no
}

detached_clone git://github.com/kergoth/homefiles ~/.fgits/homefiles.git ../..
detached_clone git://github.com/kergoth/git-scripts ~/.fgits/git-scripts.git ../../bin
curl -s https://raw.github.com/kergoth/vim-kergoth/master/scripts/setup.sh | sh

{
    echo
    echo "Homefiles configuration completed"
    echo
    echo "To enter the git context of one of the homefile repositories,"
    echo "simply run 'fgit REPO'. To leave this context, run 'unfgit'."
    echo
    echo "Alternatively, particularly if not using zsh, you can use 'vcsh'"
    echo "to spawn a new shell in this context."
    echo
    echo "Available repositories:"
    /bin/ls ~/.fgits 2>/dev/null | sed -e's,\.git$,,'
    echo
}>&2