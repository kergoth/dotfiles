#!/bin/bash
# Courtesy http://waxandwane.org/dvtm.html, with modification

if [[ $# -ne 1 || -z $1 ]]; then
    echo -e "Usage:  ${0##*/}  \n" 1>&2
    exit 1
fi

ID=$(echo $1 | tr [A-Z] [a-z])
FIFO="$HOME/.dvtm-$ID-status"

[ -e "$FIFO" ] || mkfifo "$FIFO"
chmod 600 $FIFO

HOSTNAME=${HOSTNAME:-$(hostname)}
while true; do
    UPTIME=$(uptime | sed 's/.*ages*: //')
    DATE=$(date +"%a %d-%b-%g %l:%M %p")
    printf "$ID | $LOGNAME@$HOSTNAME | $UPTIME | $DATE"
    sleep 60
done > $FIFO &

STATUS_PID=$!
trap "kill $STATUS_PID; rm $FIFO" EXIT INT TERM
disown $STATUS_PID
export DVTM_ID=$ID
dvtm -s $FIFO 2>/dev/null
