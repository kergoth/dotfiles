#!/bin/bash

set -u


function normalize_path()
{
    # Remove all /./ sequences.
    local   path=${1//\/.\//\/}

    # Remove dir/.. sequences.
    while [[ $path =~ ([^/][^/]*/\.\./) ]]
    do
        path=${path/${BASH_REMATCH[0]}/}
    done
    echo $path
}

link_dotfile () {
    dotfile=${1#$PWD/}
    if [ $# -gt 1 ]; then
        dotfile_dest=$2
    else
        dotfile_dest="$HOME/.$dotfile"
    fi
    destdir="${dotfile_dest%/*}"
    dotfile_relpath="$(relpath "$destdir" "$PWD/$dotfile")"

    # Sanity check
    dotfile_resolved="$(normalize_path "${dotfile_dest%/*}/$dotfile_relpath")"
    if [ ! -e "$dotfile_resolved" ]; then
        echo >&2 "Error: $dotfile_resolved does not exist"
        return 1
    fi

    printf "$dotfile_relpath\t$dotfile_dest\n"
}


cd ${0%/*}/..
PATH=$PWD/bin:$PATH

printf "$(relpath $HOME $PWD/bin)\t$HOME/bin\n"
link_dotfile zshenv
link_dotfile boom
link_dotfile Xresources
link_dotfile gemrc
link_dotfile hgrc
link_dotfile netrc
link_dotfile lmwsaction.ini

for dotfile in ssh/* config/*; do
    link_dotfile "$dotfile"
done

if test "$(uname -s)" = "Darwin"; then
    stpath="$HOME/Library/Application Support/Sublime Text 2"
else
    stpath="$HOME/.config/sublime-text-2"
fi
for path in config/sublime-text-2/Packages/*; do
    link_dotfile "$path" "$stpath/Packages/${path##*/}"
done

exit 0
