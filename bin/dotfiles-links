#!/bin/sh

excluded="bin|bootstrap|oh-my-zsh|config|TODO|BUGS|MacOSX"
if echo $OSTYPE | grep -q "^darwin"; then
    # We don't want XQuartz trying to spawn sscrotwm
    excluded="$excluded|xinitrc"
fi

bindir=$(readlink $(dirname $0) 2>/dev/null)
if [ $? -ne 0 ]; then
    bindir=$(cd $(dirname $0) && pwd)
fi
dotfiles=$(dirname $bindir)
if [ ! -e $dotfiles/.git ] && [ ! -e $dotfiles/.hg ]; then
    echo >&2 "Unable to locate dotfiles, falling back to ~/.dotfiles"
    dotfiles=$HOME/.dotfiles
fi

alias relpath=$(cd $dotfiles/bin && pwd)/relpath

relative_from_home=$(relpath $HOME $dotfiles)
cd $dotfiles

printf "$relative_from_home/bin\t$HOME/bin\n"
ls | grep -Ev "^($excluded)$" | while read path; do
    printf "$relative_from_home/$path\t$HOME/.$path\n"
done

if test -e config; then
    mkdir -p $HOME/.config
    ls config | cut -d/ -f2- | grep -v sublime | while read path; do
        relative_path=$(relpath $HOME/.config $dotfiles/config/$path)
        printf "$relative_path\t$HOME/.config/$path\n"
    done
fi

if test "$(uname -s)" = "Darwin"; then
    if [ -e $relative_from_home/MacOSX ]; then
        printf "$relative_from_home/MacOSX\t$HOME/.MacOSX\n"
    fi

    stpath="$HOME/Library/Application Support/Sublime Text 2"
else
    stpath="$HOME/.config/sublime-text-2"
fi
packages=$stpath/Packages
relative_path="$(relpath "$packages" "$dotfiles/config/sublime-text-2/Packages")"

ls config/sublime-text-2/Packages | cut -d/ -f2- | while read path; do
    printf "$relative_path/$path\t$packages/$path\n"
done
