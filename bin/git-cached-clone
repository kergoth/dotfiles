#!/bin/sh
#
# git-cached-clone
#
# Clone a url to a destination, as git clone does, but cache as well, such
# that all clones of a given url share the same core git objects, which saves
# disk space and reduces the load on the git server.  This is transparent to
# the user of the cloned repository, as it still points at upstream, and
# future updates from that clone will use the original URL, not the cache.
#
# If you attempt to clone a URL while offline, and the url has been cached, it
# will still give you an entirely functional cloned repository, but its
# contents will be based upon the most recent cache update.
#
# This updates the cache for a given URL whenever you clone from that URL.

set -e

cachedir=$HOME/.braid/cache

main () {
    url="$1"
    shift || {
        echo >&2 "Usage: git cached-clone URL [DEST]"
        exit 2
    }
    if ! echo "$url" | grep -q "\.git/\?$"; then
        url="$url.git"
    fi

    dest="$1"
    if [ -z "$dest" ]; then
        dest="$(default_destination "$url")"
    fi

    cache_url="$(real_url "$url")"
    ret=0
    cached="$(setup_cache "$cache_url")" || ret=$?
    if [ $ret -ne 0 ] && [ ! -e "$cached" ]; then
        exit $ret
    fi

    local_clone "$url" "$cached" "$dest"
}

real_url () {
    url="$1"
    git config --global --get-regexp "url\..*\.insteadof" | {
        while read real other; do
            realurl="$(echo "$real"|sed 's,^url\.,,; s,\.insteadof$,,')"
            if echo "$url" | grep -q "^$other"; then
                echo $url | sed -e "s,^$other,$realurl,"
                return
            fi
        done
        echo "$url"
    }
}

default_destination () {
    url="$1"
    desturl="$(echo "$url"|tr ':' '/'|sed 's,\.git/*$,,')"
    sanitize "$(basename "$desturl")"
}

setup_cache () {
    url="$1"
    sanitized="$(sanitize "$url")"
    cached="$cachedir/$sanitized"

    echo "$cached"

    if [ ! -d "$cached" ]; then
        git clone --mirror "$url" "$cached" >&2 || return 1
        git "--git-dir=$cached" repack -A -d >&2
    else
        git "--git-dir=$cached" fetch >&2 || return 1
    fi
}

local_clone () {
    url="$1"; cached="$2"; dest="$3"
    git clone --reference "$cached" "$cached" "$dest"
    git "--git-dir=$dest/.git" remote set-url origin "$url"
}

sanitize () {
    echo "$@" | tr "[:upper:]" "[:lower:]" | \
              tr "[]()&~@#%^&*()_+=;:,\$/" " " | tr " " "_"
}

main "$@"
