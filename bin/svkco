#!/usr/bin/env python

# import kergsvk
from kergsvk import *

def checkout(path, localpath):
    depot = None
    for key in dm.bykey.keys():
        if path.startswith(key):
            depot = key
            depotpath = dm.bykey[depot]
            svnpath = "file://%s" % os.path.join(depotpath, path[len(key):])

    if not depot:
        raise Exception("Unable to locate depot of %s" % path)

    def cocb(arg, dirname, fnames):
        import re
        args = [ Config.svn, 'propget', 'svn:externals', re.sub("^%s" % localpath, svnpath, dirname) ]
        dirext = runcmd(args)

        if dirext == '':
            return

        import re
        for line in re.split('[\n\r]*', dirext):
            if line == '':
                continue
            (dest, src) = line.split()
            arg.append((os.path.join(dirname, dest), src))

    # svk co --export PATH LOCALPATH
    print(runcmd([ Config.svk, 'co', path, localpath ]))

    # traverse the new checkout with os.path.walk, checking for externals
    externals = []
    os.path.walk(localpath, cocb, externals)

    if Config.mode == 'detached':
        runcmd([ Config.svk, 'co', '--detach', localpath ])

    for ext,upstream in externals:
        mipath = None
        for url in mi.byvalue.keys():
            i = upstream.replace('svn.wowace.com', 'dev.wowace.com')
            if i.startswith(url):
                mipath = mi.byvalue[url]
                break

        if not mipath:
            raise Exception("Unable to checkout %s, as %s is not yet mirrored." % (path, upstream))

        rest = upstream[len(url)+1:]
        if rest.endswith('/'):
            rest = rest[:-1]

        extcopath = os.path.join(Config.checkoutspath, rest.replace('/','_'))
        if not updated_cache.get(rest):
            extsvkpath = os.path.join(mipath, rest)

            if os.path.exists(extcopath):
                print(runcmd([Config.svk, 'up', extcopath]))
            else:
                print(runcmd([Config.svk, 'co', extsvkpath, extcopath]))

            updated_cache[rest] = True

        if not os.path.exists(os.path.dirname(ext)):
            os.makedirs(os.path.dirname(ext))

        if Config.mode == 'detached':
            runcmd(['cp', '-av', extcopath, ext])
        else:
            runcmd(['ln', '-sf', extcopath, ext])

updated_cache = {}

print("Querying svk for mirror list")
mi = SVKList('mi')

print("Querying svk for depotmap")
dm = SVKList('depotmap')

import sys,os
try:
    for n in range(1,len(sys.argv)):
        i = sys.argv[n]
        copath = os.path.join(os.path.abspath(os.curdir), os.path.basename(i))
        runcmd(['rm', '-rf', copath])
        print("Checking out %s" % i)
        checkout(i, copath)
except SVKError:
    import sys
    sys.__stderr__.write(str(sys.exc_value))
    sys.exit(1)
