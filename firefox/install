case "$OSTYPE" in
    darwin*)
        ff_profileroot="$HOME/Library/Application Support/Firefox"
        ;;
    WSL)
        ff_profileroot="$USERPROFILE/AppData/Roaming/Mozilla/Firefox"
        ;;
    *)
        ff_profileroot=
        ;;
esac

if [ -d "$ff_profileroot" ]; then
    PROFILE="$(python3 -c "import configparser, sys; c = configparser.RawConfigParser(); c.read_file(sys.stdin); default = list(filter(lambda s: s.get('default') and s.get('path'), c.values()))[0]; print(default.get('path'));" <"$ff_profileroot/profiles.ini")"
    if [ -n "$PROFILE" ]; then
        PROFILE="$ff_profileroot/$PROFILE"
    fi
else
    PROFILE=
fi

if [ -d "$PROFILE" ]; then
    link user-overrides.js "$PROFILE/user-overrides.js"
    if ! [ -e "$PROFILE/updater.sh" ]; then
        curl -fsSL https://github.com/ghacksuserjs/ghacks-user.js/raw/master/updater.sh -o "$PROFILE/updater.sh"
    fi
    if ! [ -e "$PROFILE/user.js" ]; then
        ( cd "$PROFILE" && bash ./updater.sh -merge -updatebatch; )
    fi
fi

link addons-script-config.toml $XDG_CONFIG_HOME/firefox-addons/config.toml

# vim: set ft=sh :
