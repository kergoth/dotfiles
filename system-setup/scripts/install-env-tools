#!/bin/sh

export CFLAGS="${CFLAGS--O2}"
export LDFLAGS

# Shut up 2.7 deprecation warning
export PYTHONWARNINGS=ignore:DEPRECATION

# shellcheck disable=SC2039
case "$OSTYPE" in
    darwin*)
        if command -v brew >/dev/null 2>&1; then
            eval "$(brew environment --shell=auto | grep -vw PATH)"
            CFLAGS="$CFLAGS -I$(brew --prefix openssl)/include -I$(xcrun --show-sdk-path)/usr/include"
            LDFLAGS="$LDFLAGS -L$(brew --prefix openssl)/lib"
            : "${HOMEBREW_PREFIX:=/opt/homebrew}"
            export OPENSSL_DIR="$HOMEBREW_PREFIX/opt/openssl"
        fi
        ;;
esac

pythonuserdir="$(python -c 'import site; print(site.getuserbase())')" || exit 1
PATH="$pythonuserdir/bin:$(dirname "$0"):$HOME/.local/bin:$PATH"


pipv_installed () {
    pipsi list | sed -n -e 's/^  *Package "\([^"]*\)":$/\1/p' | grep -Fqx "$1"
}

pipx_installed () {
    pipx list | sed -n -e 's/^   *package \([^ ]*\).*/\1/p' | grep -Fqx "$1"
}

pipv () {
    if pipv_installed "$1"; then
        kpipsi upgrade "$@"
    else
        kpipsi install "$@"
    fi || { echo >&2 "Error installing $*"; return 1; }
}

pipv3 () {
    pipv3_venv="$1"
    shift
    if pipx_installed "$pipv3_venv"; then
        pipx upgrade "$pipv3_venv" || { echo >&2 "Error upgrading $pipv3_venv with pipx"; return 1; }
    else
        pipx install "$pipv3_venv" || { echo >&2 "Error installing $pipv3_venv with pipx"; return 1; }
    fi
    if [ $# -gt 0 ]; then
        pipx runpip "$pipv3_venv" -q --disable-pip-version-check install --user -U "$@" || { echo >&2 "Error installing $* into $pipv3_venv with pipx"; return 1; }
    fi
}

pip_install () {
    command python2 -m pip -q --disable-pip-version-check install --user -U "$@" || { echo >&2 "Error installing $*"; return 1; }
}

pip3_install () {
    command python3 -m pip -q install --user -U "$@" || { echo >&2 "Error installing $*"; return 1; }
}

mkdir -p "${XDG_DATA_HOME:-~/.local/share}"

# Clang and llvm are needed to build `bat`
if command -v pacman >/dev/null 2>&1; then
    sudo pacman -Sy --needed llvm clang
elif command -v apt-get >/dev/null 2>&1; then
    sudo apt-get -y install --no-upgrade llvm clang
fi

# cargo-update
export CARGO_INSTALL_ROOT=${CARGO_INSTALL_ROOT:-${XDG_DATA_HOME:-~/.local/share}/..}
cargo install cargo-update
cargo install-update -i fd-find ripgrep bat exa git-series

# Upgrade pip
pip_install pip==18.1
pip3_install pip

## Interactive mode python tools
pip_install see
pip3_install see

## General Tools & Utilities
go get -u github.com/junegunn/fzf/...
pip_install mercurial hg-git hg-evolve
pipv3 httpie
go get -u github.com/EricChiang/pup

# Very handy for screencasts
pipv3 asciinema

## For dotfiles
pipv3 peru

## Handy
go get -u github.com/direnv/direnv

## Script dependencies
go get -u github.com/tomnomnom/unfurl
pip_install titlecase sh # various scripts, zsh alias
pip_install 'numpy<1.17' && pip_install hungarian # git-tbdiff
pip_install gitpython # buildhistory-diff

## Pinboard client
#npmv pin-cushion
#pipv3 python-json2yaml # pcposts zsh function

## Development Tools
go get -u github.com/github/hub
pipv3 git-revise
cargo-install git-series
# pprintpp + pp-ez?
# twine?
# wheel?
#pip_install ptpython
pip_install pathlib2 click e better-exceptions-hook
pip3_install e better-exceptions-hook

## Documentation
#gemv ronn
#npmv doctoc

## Linting / Static Analysis
cabalv shellcheck ShellCheck
pipv3 flake8 pep8-naming flake8-docstrings
#pipv prospector
#pipv vim-vint
#luav luacheck
#gemv mdl # markdown
# see also markdownlint
# http://lua-users.org/wiki/LuaInspect ?
# https://code.google.com/archive/p/lua-checker/ ?
# go get github.com/BurntSushi/toml/cmd/tomlv # for toml, but it's out of date. it only supports 0.1.0

## Formatters
pipv3 yapf
# autopep8 - format code per pep8
# https://pypi.python.org/pypi/docformatter - format docstrings per pep257
go get -u github.com/shurcooL/markdownfmt
#npmv pretty-js
#luav formatter

## As Needed

#go get -u github.com/ddo/fast # bandwidth speed testing
#go get -u github.com/jbenet/go-multihash/multihash # If needed to create a hash for use by hashpipe
#go get -u github.com/jbenet/hashpipe
#pipv pockyt # cli for Pocket
#pipv pocket-cli # other cli for Pocket, better interface
#pip_install datefinder # search text for dates, ala path-extractor
#pip_install pipdeptree
#go get -u github.com/pengwynn/flint # check for missing license/etc for a project
# Seemingly no cli install for: terra (terralang.org)

### Lua Development
#luav moonscript
#luav busted

### StackOverflow from the commandline
#npmv how2

### Video Downloading
#pipv3 youtube-dl

# Dropblame, constructs git history for individual files in dropbox, using
# dropbox's revision history.
#XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
#WORKON_HOME="${WORKON_HOME:-$XDG_DATA_HOME/virtualenvs}"
#pipv dropblame &&
#    mv "$WORKON_HOME/dropblame/bin/drop" "$WORKON_HOME/dropblame/bin/dropb" && \
#    mv "$XDG_DATA_HOME/../bin/drop" "$XDG_DATA_HOME/../bin/dropb"
